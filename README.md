# FastAPI E-Commerce Application with PostgreSQL

This project is a FastAPI application with PostgreSQL database support, containerized using Docker and Docker Compose.

<a href="https://github.com/fastapi/full-stack-fastapi-template/actions?query=workflow%3ATest" target="_blank"><img src="https://github.com/fastapi/full-stack-fastapi-template/workflows/Test/badge.svg" alt="Test"></a>
<a href="https://coverage-badge.samuelcolvin.workers.dev/redirect/fastapi/full-stack-fastapi-template" target="_blank"><img src="https://coverage-badge.samuelcolvin.workers.dev/fastapi/full-stack-fastapi-template.svg" alt="Coverage"></a>

## Technology Stack and Features

- ⚡ [**FastAPI**](https://fastapi.tiangolo.com) for the Python backend API.
    - 🧰 [SQLAlchemy](https://docs.sqlalchemy.org/en/20/) for the Python SQL database interactions (ORM).
    - 🔍 [Pydantic](https://docs.pydantic.dev), used by FastAPI, for the data validation and settings management.
    - 💾 [PostgreSQL](https://www.postgresql.org) as the SQL database.
- 🐋 [Docker Compose](https://www.docker.com) for development and production.

## Prerequisites

- Docker
- Docker Compose
- Git

## Project Structure

```
.
├── app/
│   ├── core/           # Application configuration, settings, and core utilities
│   ├── lib/            # Common libraries and helper functions
│   ├── models/         # SQLAlchemy database models
│   ├── routers/        # FastAPI route definitions and endpoints
│   ├── schemas/        # Pydantic models for request/response validation
│   ├── services/       # Business logic and service layer
│   └── tests/          # Unit and integration tests
├── alembic/            # Database migrations
│   ├── versions/
│   └── env.py
├── alembic.ini        # Alembic configuration file
├── docker-compose.yml  # Docker services configuration
├── Dockerfile         # Docker image definition
├── entrypoint.sh     # Container startup script
├── requirements.txt   # Production dependencies
├── dev_requirements.txt # Development dependencies
├── setup_db.py       # Database initialization script
└── .env              # Environment variables
```

## Configuration

### Environment Variables

1. Copy the `.env.example` file to create your `.env` file:

```bash
cp .env.example .env
```

2. Configure the following environment variables in your `.env` file:

- `API_PORT`: The port on which the API will be exposed (default: 8000)
- `DB_PORT`: PostgreSQL database port (default: 5432)
- `POSTGRES_USER`: Database username
- `POSTGRES_PASSWORD`: Database password
- `POSTGRES_DB`: Database name
- `POSTGRES_SERVER`: Database host (default: db)
- `ENVIRONMENT`: Application environment (development/production)
- `ENV`: Environment for installing dependencies (development/production)
- `PRODUCT_TOKEN`: Custom token for product-related functionality
- `ORDER_TOKEN`: Custom token for order-related functionality

## Getting Started

### Build and Run

1. Build and start the containers:

```bash
docker compose up --build
```

This command will:
- Build the API container with the necessary dependencies
- Start the PostgreSQL database
- Run database migrations
- Start the FastAPI application

2. Access the API:
- The API will be available at: `http://localhost:{API_PORT}`
- Default: `http://localhost:8000`

3. API Documentation:
- Swagger UI (OpenAPI): `http://localhost:{API_PORT}/docs`
- ReDoc: `http://localhost:{API_PORT}/redoc`
- OpenAPI JSON Schema: `http://localhost:{API_PORT}/openapi.json`

These interactive documentation endpoints are automatically generated by FastAPI and provide:
- Complete API documentation
- Interactive API testing interface
- Request/response examples
- Schema definitions

### Development Mode

The application is configured to run in development mode by default, which includes:
- Hot-reload for code changes
- Installation of development dependencies
- Volume mounting for local development

### Database

The PostgreSQL database is automatically:
- Created if it doesn't exist
- Configured with the specified credentials
- Persisted using Docker volumes
- Health-checked before the API starts

## Docker Configuration

### API Service
- Base image: Python 3.11 slim
- Builds with development dependencies if ENV=development
- Exposes port 8000
- Depends on database service
- Mounts local directory for development

### Database Service
- PostgreSQL 13.14
- Persistent storage using Docker volumes
- Configured with environment variables
- Health check enabled

## Scripts

### entrypoint.sh
The entrypoint script automatically:
1. Creates the database if it doesn't exist
2. Runs database migrations
3. Starts the FastAPI application with 2 workers

## Development

### Local Development
The application is configured for easy local development:
- Code changes are reflected immediately due to volume mounting
- Database data persists between container restarts
- Development dependencies are installed automatically

## Testing

### Running Tests
Tests are only available in the development environment as pytest is included in `dev_requirements.txt`.

1. Ensure you're running in development mode:
```bash
# In your .env file
ENVIRONMENT=development
ENV=development
```

2. Connect to the API container:
```bash
docker exec -it <container_id> bash
```

3. Run tests using pytest:
```bash
# Run all tests
pytest

# Run tests with verbose output
pytest -v

# Run tests with coverage report
pytest --cov=app

# Run specific test file
pytest app/tests/integrations/test_product_service.py

### Adding Dependencies
1. Add new production dependencies to `requirements.txt`
2. Add development dependencies to `dev_requirements.txt`
3. Rebuild the containers:
```bash
docker compose down
docker compose up --build
```

## Database Migrations with Alembic

### Automatic Migration Execution
The `entrypoint.sh` script automatically runs all pending migrations when the container starts using:
```bash
alembic upgrade head
```

More about alembic here: https://alembic.sqlalchemy.org/en/latest/

### Manual Migration Commands

You can run these commands inside the API container:

- Apply all migrations:
```bash
alembic upgrade head
```

- Revert last migration:
```bash
alembic downgrade -1
```

- Revert all migrations:
```bash
alembic downgrade base
```

- Get current migration version:
```bash
alembic current
```

- Generate automatic migration by comparing models to database:
```bash
alembic revision --autogenerate -m "description_of_changes"
```

### Best Practices

1. Always review autogenerated migrations before applying them
2. Test migrations both forwards and backwards
3. Include meaningful descriptions in migration names
4. Keep migrations atomic (one conceptual change per migration)
5. Don't modify existing migrations after they've been committed to version control

## Troubleshooting

### Database Connection Issues
If you experience database connection issues:
1. Ensure the database container is healthy:
```bash
docker compose ps
```
2. Check database logs:
```bash
docker compose logs db
```
3. Verify your `.env` configuration matches the database settings

### Container Issues
To reset the environment:
```bash
docker compose down -v  # Remove containers and volumes
docker compose up --build  # Rebuild and start containers
```

## License

This app is licensed under the terms of the MIT license.
